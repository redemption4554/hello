<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ClÃ©mence - Ã‰ternitÃ©</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Montserrat:wght@200;400;900&display=swap');

        :root {
            --gold: #d4af37;
            --red: #ff0033;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: #000; 
            height: 100dvh; /* Utilise la hauteur dynamique de Safari */
            width: 100vw;
            overflow: hidden; 
            font-family: 'Montserrat', sans-serif; 
            position: fixed;
        }

        /* Canvas - Couvre tout l'Ã©cran proprement */
        #world {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
            z-index: 1;
        }

        /* Gate UI */
        #gate {
            position: fixed; inset: 0; background: #000; z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .btn-luxe {
            background: none; border: 1px solid var(--gold); color: var(--gold);
            padding: 15px 30px; font-family: 'Cinzel', serif; letter-spacing: 4px;
            text-transform: uppercase; cursor: pointer; font-size: 0.8rem;
        }

        /* UI du haut */
        #ui-top {
            position: absolute; top: 15%; left: 0; width: 100%;
            text-align: center; z-index: 5; pointer-events: none;
            opacity: 0; transition: 1s;
        }
        .message-box {
            font-family: 'Cinzel', serif; color: var(--gold);
            font-size: 0.75rem; letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(0,0,0,0.8);
        }

        /* JE T'AIME - Centrage absolu par Flexbox */
        .center-container {
            position: absolute;
            inset: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            pointer-events: none;
        }
        
        .main-heart-btn {
            font-family: 'Cinzel', serif; 
            color: #fff; 
            font-size: 1.8rem;
            letter-spacing: 5px; 
            text-shadow: 0 0 25px var(--red);
            pointer-events: all;
            opacity: 0;
            transition: opacity 1s, transform 0.2s;
            cursor: pointer;
            margin-top: -5px; /* Ajustement optique */
        }

        /* CADENAS - Position "Safe Zone" pour iPhone */
        #secret-btn {
            position: absolute; 
            bottom: 120px; 
            left: 50%; transform: translateX(-50%);
            width: 60px; height: 60px; border-radius: 50%;
            border: 1px solid var(--gold);
            background: rgba(0,0,0,0.8); z-index: 150;
            display: flex; justify-content: center; align-items: center;
            color: var(--gold); font-size: 1.3rem;
            pointer-events: all;
            opacity: 0;
            transition: 1s;
        }
        #hold-fill {
            position: absolute; inset: -3px; border-radius: 50%;
            border: 3px solid var(--gold); border-top-color: transparent;
            opacity: 0;
        }

        /* Message Supernova */
        #transition-msg {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; text-align: center; z-index: 201; color: white;
            font-family: 'Cinzel', serif; font-size: 1rem; opacity: 0; transition: 1s;
            pointer-events: none;
            text-shadow: 0 0 15px var(--gold);
        }

        /* Lettre */
        #hiddenLetter {
            position: fixed; inset: 0; background: rgba(0,0,0,0.98);
            z-index: 3000; display: none; justify-content: center; align-items: center;
            padding: 30px;
        }
        .letter-content {
            border: 1px solid var(--gold); padding: 30px; text-align: center;
            color: #fff; font-family: 'Cinzel', serif; line-height: 1.8; background: #000;
        }

        #flash { position: fixed; inset: 0; background: #fff; z-index: 1500; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

    <audio id="music" loop>
        <source src="https://www.chosic.com/wp-content/uploads/2021/07/Rainy-Day-Implicit.mp3" type="audio/mpeg">
    </audio>

    <div id="flash"></div>

    <div id="gate">
        <h2 style="color:var(--gold); font-family:'Cinzel'; margin-bottom:20px; letter-spacing:5px;">CLÃ‰MENCE</h2>
        <button class="btn-luxe" onclick="reveal()">Entrer dans mon cÅ“ur</button>
    </div>

    <div id="ui-top">
        <div class="message-box" id="m-text">BIENVENUE DANS MON CÅ’UR...</div>
    </div>

    <div id="transition-msg">CHAQUE POINT DE CE CÅ’UR CORRESPOND Ã€ MON AMOUR POUR TOI</div>

    <div class="center-container">
        <h2 class="main-heart-btn" id="main-ui" onclick="triggerAction()">JE T'AIME</h2>
    </div>

    <canvas id="world"></canvas>

    <div id="secret-btn" ontouchstart="startHold(event)" ontouchend="endHold()" onmousedown="startHold(event)" onmouseup="endHold()">
        <div id="hold-fill"></div>
        <span>ðŸ”’</span>
    </div>

    <div id="hiddenLetter" onclick="this.style.display='none'">
        <div class="letter-content">
            <h3 style="color:var(--gold); margin-bottom:15px;">Ã€ MA REINE</h3>
            <p>Tu es mon Ã©ternitÃ©. Chaque battement de ce code est pour toi.<br><br>Je t'aime plus que tout.</p>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('world');
        const ctx = canvas.getContext('2d');
        const audio = document.getElementById('music');
        
        let width, height, dpr;
        let particles = [];
        let isRevealed = false;
        let rotation = 0;
        let holdTimer;
        let clickCount = 0;
        let state = "NORMAL";

        const SOUVENIRS = ["TON SOURIRE...", "NOS NUITS...", "TON REGARD...", "NOTRE AMOUR...", "MON Ã‰TERNITÃ‰..."];

        function init() {
            // Calcul prÃ©cis pour mobile
            dpr = window.devicePixelRatio || 1;
            width = window.innerWidth;
            height = window.innerHeight;
            
            canvas.width = width * dpr;
            canvas.height = height * dpr;
            
            // Taille du coeur reculÃ©e pour bien voir la forme (0.028)
            const heartScale = Math.min(width, height) * 0.028; 
            
            particles = [];
            for(let i=0; i<3500; i++) {
                let t = Math.random() * Math.PI * 2;
                let r = Math.sqrt(Math.random()) * heartScale;
                particles.push({
                    baseX: 16 * Math.pow(Math.sin(t), 3) * r,
                    baseY: -(13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t)) * r,
                    baseZ: (Math.random()-0.5) * 160,
                    x: 0, y: 0, z: 0, vx: 0, vy: 0, vz: 0,
                    size: Math.random() * 1.3 + 0.3,
                    color: Math.random() > 0.15 ? "#ff0033" : "#d4af37"
                });
            }
            particles.forEach(p => { p.x = p.baseX; p.y = p.baseY; p.z = p.baseZ; });
        }

        function reveal() {
            audio.play();
            document.getElementById('gate').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('gate').style.display = 'none';
                document.getElementById('ui-top').style.opacity = '1';
                document.getElementById('main-ui').style.opacity = '1';
                document.getElementById('secret-btn').style.opacity = '1';
                isRevealed = true;
            }, 800);
        }

        function triggerAction() {
            if(!isRevealed || state !== "NORMAL") return;
            const txt = document.getElementById('m-text');
            txt.style.opacity = 0;
            setTimeout(() => {
                txt.innerText = SOUVENIRS[clickCount % SOUVENIRS.length];
                txt.style.opacity = 1;
                clickCount++;
                if(clickCount === 6) startSupernova();
            }, 250);
        }

        function startSupernova() {
            state = "EXPLODING";
            document.getElementById('main-ui').style.opacity = '0';
            document.getElementById('ui-top').style.opacity = '0';
            
            setTimeout(() => {
                document.getElementById('flash').style.opacity = '1';
                setTimeout(() => {
                    document.getElementById('flash').style.opacity = '0';
                    particles.forEach(p => {
                        let f = Math.random() * 50 + 20;
                        p.vx = (Math.random() - 0.5) * f;
                        p.vy = (Math.random() - 0.5) * f;
                        p.vz = (Math.random() - 0.5) * f;
                    });
                    setTimeout(() => {
                        state = "MESSAGE";
                        document.getElementById('transition-msg').style.opacity = '1';
                        setTimeout(() => {
                            document.getElementById('transition-msg').style.opacity = '0';
                            state = "REFORMING";
                            setTimeout(() => {
                                state = "NORMAL"; clickCount = 0;
                                document.getElementById('main-ui').style.opacity = '1';
                                document.getElementById('ui-top').style.opacity = '1';
                            }, 3000);
                        }, 4000);
                    }, 2000);
                }, 100);
            }, 800);
        }

        function startHold(e) {
            const fill = document.getElementById('hold-fill');
            fill.style.opacity = "1";
            fill.animate([{transform: 'rotate(0)'}, {transform: 'rotate(360deg)'}], {duration: 1000, iterations: Infinity});
            holdTimer = setTimeout(() => {
                document.getElementById('hiddenLetter').style.display = 'flex';
                endHold();
            }, 1500);
        }
        function endHold() { clearTimeout(holdTimer); document.getElementById('hold-fill').style.opacity = "0"; }

        function animate() {
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // Reset de la transformation
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.fillRect(0,0,width,height);

            if(isRevealed) {
                rotation += 0.014;
                let pulse = 1 + Math.sin(Date.now() * 0.003) * 0.1;

                // --- CENTRAGE ABSOLU DU DESSIN ---
                ctx.translate(width / 2, height / 2);

                particles.forEach((p) => {
                    if(state === "EXPLODING") {
                        p.x += p.vx; p.y += p.vy; p.z += p.vz;
                        p.vx *= 0.96; p.vy *= 0.96; p.vz *= 0.96;
                    } else if(state === "REFORMING") {
                        p.x += (p.baseX - p.x) * 0.1;
                        p.y += (p.baseY - p.y) * 0.1;
                        p.z += (p.baseZ - p.z) * 0.1;
                    }

                    let cosR = Math.cos(rotation), sinR = Math.sin(rotation);
                    let rx = p.x * cosR - p.z * sinR;
                    let rz = p.x * sinR + p.z * cosR;
                    let s = 400 / (400 + rz + 150);
                    
                    let px = rx * s * (state === "NORMAL" ? pulse : 1);
                    let py = p.y * s * (state === "NORMAL" ? pulse : 1);

                    ctx.globalAlpha = Math.min(1, s);
                    ctx.fillStyle = p.color;
                    ctx.fillRect(px, py, p.size * s, p.size * s);
                });
            }
            requestAnimationFrame(animate);
        }

        init(); animate();
        window.addEventListener('resize', init);
    </script>
</body>
</html>
